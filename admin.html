<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Admin Dashboard</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

<style>
body { padding-bottom: 70px; }
.img-thumb { width:42px;height:42px;object-fit:cover;cursor:pointer }
.action-btns button { margin:2px }
</style>
</head>

<body class="bg-light">

<nav class="navbar bg-white shadow-sm px-3 d-flex justify-content-between">
  <strong>My School</strong>
  <span>Admin</span>
</nav>

<div class="container mt-3">

<ul class="nav nav-tabs d-none d-md-flex">
  <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tabStudents">Students</button></li>
  <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabAdd">Add / Edit</button></li>
  <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabAttendance">Attendance</button></li>
</ul>

<div class="tab-content mt-3">

<!-- ================= STUDENTS ================= -->
<div class="tab-pane fade show active" id="tabStudents">

<div class="row g-2 mb-2">
  <div class="col-md-3">
    <select id="statusFilter" class="form-select" onchange="renderStudents()">
      <option value="all">All Status</option>
      <option value="active">Active</option>
      <option value="suspended">Suspended</option>
    </select>
  </div>
  <div class="col-md-3">
    <select id="roleFilter" class="form-select" onchange="renderStudents()">
      <option value="all">All Roles</option>
      <option value="student">Student</option>
      <option value="operator">Operator</option>
    </select>
  </div>
  <div class="col-md-6">
    <input id="searchTxt" class="form-control" placeholder="Search..." onkeyup="renderStudents()">
  </div>
</div>

<div class="table-responsive">
<table class="table table-bordered table-sm align-middle">
<thead class="table-light">
<tr>
<th>Photo</th><th>Name</th><th>Parent</th><th>Role</th><th>Status</th><th>Actions</th>
</tr>
</thead>
<tbody id="studentTable"></tbody>
</table>
</div>
</div>

<!-- ================= ADD ================= -->
<div class="tab-pane fade" id="tabAdd">
<input id="sname" class="form-control mb-2" placeholder="Student Name">
<input id="pname" class="form-control mb-2" placeholder="Parent Name">
<select id="role" class="form-select mb-2">
  <option value="student">Student</option>
  <option value="operator">Operator</option>
</select>
<input type="file" id="img" class="form-control mb-2" accept="image/*">
<button id="saveBtn" class="btn btn-success w-100" onclick="saveStudent()">Save</button>
</div>

<!-- ================= ATTENDANCE ================= -->
<div class="tab-pane fade" id="tabAttendance">
<div class="row g-2 mb-2">
  <div class="col-md-4"><input type="month" id="monthFilter" class="form-control" onchange="renderAttendance()"></div>
  <div class="col-md-4"><input type="date" id="fromDate" class="form-control" onchange="renderAttendance()"></div>
  <div class="col-md-4"><input type="date" id="toDate" class="form-control" onchange="renderAttendance()"></div>
</div>

<div class="table-responsive">
<table class="table table-bordered table-sm" id="attendanceTable">
<thead id="attendanceHead"></thead>
<tbody id="attendanceBody"></tbody>
</table>
</div>
</div>

</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
/* ================= API ================= */
const API_URL =
"https://script.google.com/macros/s/AKfycbxAHmQCPBJFUA6zfBtf4V8XNOC9tdpmSCbB4fI_Bnf84uVYbKWAWI3sz1jC4Hz78y4hGQ/exec";

let students = [];
let editId = null;

/* ================= LOAD ================= */
function loadStudents(){
  fetch(API_URL)
    .then(r => r.json())
    .then(data => {

      // API returns array of objects
      students = data.map(r => ({
        id: r.Id,
        date: r.date,
        image: r.image,
        name: r.Student,
        parentName: r.parentt,
        role: r.Role,
        status: r.Status
      }));

      renderStudents();
      renderAttendance();
    });
}

/* ================= SAVE ================= */
function saveStudent(){
  editId ? updateStudent() : createStudent();
}

function createStudent(){
  if(!img.files[0]) return alert("Upload image");

  const r=new FileReader();
  r.onload=()=>{
    const p=new URLSearchParams();
    p.append("id",Date.now());
    p.append("photo",r.result);
    p.append("name",sname.value);
    p.append("parentname",pname.value);
    p.append("role",role.value);

    fetch(API_URL,{method:"POST",body:p})
      .then(()=>{ clearForm(); loadStudents(); });
  };
  r.readAsDataURL(img.files[0]);
}

function updateStudent(){
  const s=students.find(x=>x.id===editId);
  const p=new URLSearchParams();
  p.append("action","edit");
  p.append("id",s.id);
  p.append("photo",s.image);
  p.append("name",sname.value);
  p.append("parentname",pname.value);
  p.append("role",role.value);

  fetch(API_URL,{method:"POST",body:p})
    .then(()=>{ clearForm(); loadStudents(); });
}

function clearForm(){
  editId=null;
  sname.value=pname.value="";
  img.value="";
  saveBtn.innerText="Save";
}

/* ================= ACTIONS ================= */
function editStudent(id){
  const s=students.find(x=>x.id===id);
  editId=id;
  sname.value=s.name;
  pname.value=s.parentName;
  role.value=s.role;
  saveBtn.innerText="Update";
  new bootstrap.Tab(document.querySelector('[data-bs-target="#tabAdd"]')).show();
}

function setStatus(id,status){
  const p=new URLSearchParams();
  p.append("action",status==="deleted"?"delete":"status");
  p.append("id",id);
  if(status!=="deleted") p.append("status",status);

  fetch(API_URL,{method:"POST",body:p})
    .then(loadStudents);
}

/* ================= TABLE ================= */
function renderStudents(){
  const sf=statusFilter.value;
  const rf=roleFilter.value;
  const txt=searchTxt.value.toLowerCase();

  studentTable.innerHTML=students.filter(s=>{
    if(sf!=="all" && s.status!==sf) return false;
    if(rf!=="all" && s.role!==rf) return false;
    if(txt && !s.name.toLowerCase().includes(txt)) return false;
    return true;
  }).map(s=>`
<tr>
<td><img src="${s.image}" class="img-thumb rounded-circle"></td>
<td>${s.name}</td>
<td>${s.parentName}</td>
<td>${s.role}</td>
<td>${s.status}</td>
<td class="action-btns">
<button class="btn btn-sm btn-primary" onclick="editStudent(${s.id})">✏️</button>
<button class="btn btn-sm btn-warning" onclick="setStatus(${s.id},'suspended')">Suspend</button>
<button class="btn btn-sm btn-success" onclick="setStatus(${s.id},'active')">Activate</button>
<button class="btn btn-sm btn-danger" onclick="setStatus(${s.id},'deleted')">Delete</button>
</td>
</tr>`).join("");
}

/* ================= ATTENDANCE (LOCAL) ================= */
let attendance=JSON.parse(localStorage.getItem("attendance"))||[];

function getDatesInRange(a,b){
  let d=new Date(a),arr=[];
  while(d<=b){ arr.push(new Date(d)); d.setDate(d.getDate()+1); }
  return arr;
}

function renderAttendance(){
  if(!monthFilter.value) return;
  let [y,m]=monthFilter.value.split("-");
  let start=new Date(y,m-1,1);
  let end=new Date(y,m,0);
  let dates=getDatesInRange(start,end);

  attendanceHead.innerHTML="<tr><th>Student</th>"+dates.map(d=>`<th>${d.getDate()}</th>`).join("")+"</tr>";
  attendanceBody.innerHTML=students.filter(s=>s.status==="active").map(s=>`
<tr>
<td>${s.name}</td>
${dates.map(d=>{
  const ds=d.toISOString().slice(0,10);
  const chk=attendance.find(a=>a.studentId===s.id&&a.date===ds);
  return `<td class="text-center">
  <input type="checkbox" ${chk?"checked":""}
  onchange="toggleAttendance(${s.id},'${ds}',this.checked)">
  </td>`;
}).join("")}
</tr>`).join("");
}

function toggleAttendance(id,date,val){
  let i=attendance.findIndex(a=>a.studentId===id&&a.date===date);
  if(val && i<0) attendance.push({studentId:id,date});
  if(!val && i>=0) attendance.splice(i,1);
  localStorage.setItem("attendance",JSON.stringify(attendance));
}

/* ================= INIT ================= */
const now=new Date();
monthFilter.value=`${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,"0")}`;
loadStudents();
</script>

</body>
</html>
